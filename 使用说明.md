# 使用说明

适用于在本地或作为 NPM 包使用 twspace-crawler，包含：
- 如何通过 CLI 下载特定 Space
- 如何在运行期动态切换 auth_token/ct0（避免重启）
- 如何在其他项目中以依赖包方式调用

先决条件
- Node.js >= 14
- 已安装 ffmpeg（用于合并音频）

CLI 用法
- 安装与构建（从源码运行）
  - `npm ci`
  - `npm run build`
  - 运行：`npm start -- [选项]`

- 下载特定 Space
  - 通过 Space ID：
    - `npm start -- --id <SPACE_ID> [--auth-token <AUTH>] [--csrf-token <CT0>] [--force]`
    - 示例：`npm start -- --id 1ZkKAbCdEfG --auth-token X... --csrf-token Y... --force`
    - 说明：`--force` 可在 Space 已结束时直接尝试下载（避免等待轮询）。
  - 通过 Space URL：
    - `npm start -- --space-url https://twitter.com/i/spaces/<SPACE_ID> [--auth-token ...] [--csrf-token ...]`

- 通过播放列表 URL（已知 m3u8）直接下载
  - `npm start -- --url <PLAYLIST_M3U8_URL>`
  - 示例：`npm start -- --url https://prod-fastly-.../master_playlist.m3u8`

- 监听用户（自动发现直播并下载）
  - `npm start -- --user user1,user2 [--auth-token ...] [--csrf-token ...]`
  - 或在 `config.json` 的 `users` 中配置，使用：`npm run start:config`

动态令牌（auth_token/ct0）
- 启动参数（优先级最高）：
  - `--auth-token <AUTH_TOKEN>`、`--csrf-token <CT0>`
- 运行期热更新（无需重启）：
  - 在 `<项目根>/logs/tokens.json` 写入：
    ```json
    { "authToken": "<YOUR_AUTH_TOKEN>", "csrfToken": "<YOUR_CT0_TOKEN>" }
    ```
  - 程序会自动监听此文件变化，后续请求使用新 token。
- 环境变量（兜底初始值）：
  - `TWITTER_AUTH_TOKEN`、`TWITTER_CSRF_TOKEN`

NPM 包用法（作为依赖被其他项目调用）
- 安装
  - 从 NPM 安装（发布后）：`npm i twspace-crawler`
  - 或在本地以包形式使用：
    - 打包：`npm pack`（得到 `twspace-crawler-<version>.tgz`）
    - 在另一个项目中安装：`npm i ../path/to/twspace-crawler-<version>.tgz`
    - 或使用链接：在本仓库执行 `npm link`，在另一项目中执行 `npm link twspace-crawler`

- 以 CLI 方式在另一项目中调用
  - `npx twspace-crawler --id <SPACE_ID> [--auth-token ...] [--csrf-token ...]`
  - 或在该项目的 npm 脚本中添加：
    ```json
    { "scripts": { "dl:space": "twspace-crawler --id %SPACE_ID% --force" } }
    ```

- 以库方式（代码中调用）
  - 该包为 CommonJS 输出（`dist/**`），可直接按需导入内部模块。
  - 常见场景示例：
    1) 下载某个已知播放列表 URL（最简单）
    ```ts
    // your-app.ts
    import { tokenManager } from 'twspace-crawler/dist/modules/TokenManager'
    import { SpaceDownloader } from 'twspace-crawler/dist/modules/SpaceDownloader'

    tokenManager.init({ tokensPath: 'logs/tokens.json' }) // 可选：启用热更新

    const playlistUrl = 'https://.../master_playlist.m3u8'
    const filename = 'my-space'
    await new SpaceDownloader(playlistUrl, filename).download()
    ```

    2) 通过 Space ID 监听并下载（自动处理元数据与合并）
    ```ts
    import { tokenManager } from 'twspace-crawler/dist/modules/TokenManager'
    import { mainManager } from 'twspace-crawler/dist/modules/MainManager'

    tokenManager.init({
      authToken: process.env.TWITTER_AUTH_TOKEN,
      csrfToken: process.env.TWITTER_CSRF_TOKEN,
      tokensPath: 'logs/tokens.json',
    })

    mainManager.addSpaceWatcher('1ZkKAbCdEfG')
    ```

  - TypeScript 提示：当前包未输出 d.ts，如需类型可在消费方：
    - 直接以 JS 使用；或
    - 在 `tsconfig.json` 中启用 `skipLibCheck`/`allowJs`；或
    - 自行补充简单声明文件。

发布为 NPM 包（本项目）
- 配置已就绪：
  - `package.json` 中：
    - `bin.twspace-crawler` 指向 `dist/index.js`（安装后提供 CLI）
    - `files: ["dist/**/*.js"]` 仅发布编译文件
    - `prepare` 脚本在发布/安装前自动 `npm run build`
- 发布流程：
  - 更新版本号：`npm version patch|minor|major`
  - 登录：`npm login`
  - 发布：`npm publish`
  - 验证：`npx twspace-crawler -V`

常用选项速查
- `--id <SPACE_ID>`：通过 ID 监听并下载
- `--space-url <URL>`：通过 URL 监听并下载
- `--url <M3U8>`：直接通过播放列表下载
- `--user <U1,U2>`：监听用户列表（自动发现直播）
- `--force`：与 `--id` 搭配，强制尝试直接下载
- `--auth-token <AUTH>`、`--csrf-token <CT0>`：动态令牌（启动时）
- `--config <PATH>`：使用指定配置文件
- `--env <PATH>`：加载指定 `.env`

备注
- 令牌日志会做掩码，仅打印前缀。
- 生产环境建议把 `logs/tokens.json` 置于受控目录，仓库已忽略 `logs/`。

